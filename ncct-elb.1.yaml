AWSTemplateFormatVersion: "2010-09-09"
Description: NCCT Server Load Balancer
Parameters:  
  ElbSNs:
    Type: 'List<AWS::EC2::Subnet::Id>'
    Description: The list of SubnetIds in your Virtual Private Cloud (VPC) for your ELB
  ElbSGs:
    Type: 'List<AWS::EC2::SecurityGroup::Id>'
    Description: The list of Security Groups used by your ELB
  ResourcePrefix:
    Type: String
    Default: NCCT
    Description: The prefix for resource names
  SvcAbbr:
    Type: String
    Description: Service abbreviation e.g. SMS, BIN, etc.
  Owner:
    Type: String    
    Description: The administrator of this instance's email address
  Desc:
    Type: String
    Description: Value for Description tag
  Protocol:
    Type: String
    Default: HTTP
    Description: Protocol used by the load balancer and EC2 instance
  ElbPort:
    Type: String
    Default: '80'
    Description: TCP port that the load balancer listens on for incoming traffic
  Ec2Port:
    Type: String
    Default: '80'
    Description: TCP port that managed EC2 instances listens on
Conditions: 
  ProtocolHTTP: !Equals [!Ref Protocol, "HTTP"]
Resources:
  LoadBalancer:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      LoadBalancerName: !Join ["-", [!Ref ResourcePrefix, !Ref SvcAbbr, "ELB"]]
      HealthCheck:
        HealthyThreshold: '3'
        Interval: '10'
        Target: !Join ["", [!Ref Protocol, ":", !Ref ElbPort, !If [ProtocolHTTP, "/", ""]]]
        Timeout: '5'
        UnhealthyThreshold: '5'
      Listeners:
      - LoadBalancerPort: !Ref ElbPort
        InstancePort: !Ref Ec2Port
        Protocol: !Ref Protocol
      Scheme: internal
      SecurityGroups: !Ref ElbSGs
      Subnets: !Ref ElbSNs
      Tags:
      - Key: Name
        Value: !Join ["-", [!Ref ResourcePrefix, !Ref SvcAbbr, "ELB"]]
      - Key: Owner
        Value: !Ref Owner
      - Key: Description
        Value: !Ref Desc
Outputs:
  ElbName:
    Description: Load Balancer Resource
    Value: !Ref LoadBalancer
  ElbDnsName:
    Description: DNS Name for Elastic Load Balancer
    Value: !GetAtt LoadBalancer.DNSName
  ElbDnsKVP:
    Description: Key-value pair for a DNS entry in a hashtable.
    Value: !Join ["=", [!Join ["-", ["NCCT", !Ref SvcAbbr, "ELB"]],  !GetAtt LoadBalancer.DNSName]]