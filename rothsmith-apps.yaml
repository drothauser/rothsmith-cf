AWSTemplateFormatVersion: "2010-09-09"
Description: Rothsmith Applications
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: Rothsmith application configuration parameters
      Parameters:
      - VPCStack
      - S3Bucket
    ParameterLabels:
      VPCStack:
        default: Enter the stack name used to create the VPC.  
      S3Bucket:
        default: Enter S3 bucket name that stores the CloudFormation templates
Parameters:
  VPCStack:
    Type: String
    Default: 'ROTHSMITH-VPC'
    Description: The VPC stack to obtain exported values from
  S3Bucket:
    Type: String
    Default: rothsmith-cloudformation
    Description: The S3 bucket containing CloudFormation templates
Mappings:
  TierMap: 
    public: 
      ami: "ami-0151f162d1ff20101"
      role: "CloudWatch"
      port: '80'
      scaling: "1,1,1"
      type: "t2.micro"
      name: Apache Web Server
      owner: drothauser@yahoo.com
      description: DMZ Apache Web Server
      svcCode: web
    private: 
      ami: "ami-07c8b576e965e389e"
      role: "CloudWatch"
      port: '8080'
      scaling: "1,1,1"
      type: "t2.micro"
      name: Tomcat Server
      owner: drothauser@yahoo.com
      description: Tomcat Server
      svcCode: tomcat
Resources:
  S3AccessRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/"
  S3RolePolicies:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: s3access
      PolicyDocument:
        Statement:
        - Effect: Allow
          Action: s3:*
          Resource: "*"
      Roles:
      - Ref: S3AccessRole
  S3InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: "/"
      Roles:
      - Ref: S3AccessRole
  Tomcat:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join
        - ''
        - - 'https://s3.amazonaws.com/'
          - !Ref S3Bucket
          - '/rothsmith-service.yaml'
      Parameters:
        ElbSNs: 
          'Fn::ImportValue': 
            !Sub '${VPCStack}-PrivateSubnet'
        ElbSGs: 
          'Fn::ImportValue': 
            !Sub '${VPCStack}-PrivateSubnetInstanceSG'
        Ec2SNs: 
          'Fn::ImportValue': 
            !Sub '${VPCStack}-PrivateSubnet'
        Ec2SGs:  
          'Fn::ImportValue': 
            !Sub '${VPCStack}-PrivateSubnetInstanceSG'
        AmiId: !FindInMap [TierMap, private, ami]
        Ec2Port: !FindInMap [TierMap, private, port]
        Ec2Role: !Ref S3InstanceProfile
        Ec2Type: !FindInMap [TierMap, private, type]
        Ec2Name: !FindInMap [TierMap, private, name]
        Ec2Owner: !FindInMap [TierMap, private, owner]
        Ec2Desc: !FindInMap [TierMap, private, description]        
        Facing: private
        Scaling: !FindInMap [TierMap, private, scaling]  
        SvcCode: !FindInMap [TierMap, private, svcCode]  
        ElbDnsKVPs: " " # Only needed for public web proxy tier
  WebProxy:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join
        - ''
        - - 'https://s3.amazonaws.com/'
          - !Ref S3Bucket
          - '/rothsmith-service.yaml'
      Parameters:
        ElbSNs: 
          'Fn::ImportValue': 
            !Sub '${VPCStack}-PublicSubnet'
        ElbSGs: 
          'Fn::ImportValue': 
            !Sub '${VPCStack}-PublicInstanceSG'
        Ec2SNs: 
          'Fn::ImportValue': 
            !Sub '${VPCStack}-PublicSubnet'
        Ec2SGs: 
          'Fn::ImportValue': 
            !Sub '${VPCStack}-PublicInstanceSG'
        AmiId: !FindInMap [TierMap, public, ami]
        Ec2Port: !FindInMap [TierMap, public, port]
        Ec2Role: !Ref S3InstanceProfile
        Ec2Type: !FindInMap [TierMap, public, type]
        Ec2Name: !FindInMap [TierMap, public, name]
        Ec2Owner: !FindInMap [TierMap, public, owner]
        Ec2Desc: !FindInMap [TierMap, public, description]        
        Facing: public
        Scaling: !FindInMap [TierMap, public, scaling] 
        SvcCode: !FindInMap [TierMap, public, svcCode]        
        ElbDnsKVPs: !Join [" ", [!GetAtt [Tomcat, Outputs.ElbDnsKVP], !GetAtt [Tomcat, Outputs.ElbDnsKVP]]]
Outputs:
  WebProxyELB:
    Description: Load Balancer Resource
    Value: !GetAtt [WebProxy, Outputs.ElbDnsName]